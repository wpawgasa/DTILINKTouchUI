<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>TDL Touch UI</title>
    <link href="../lib/kendoUI/styles/kendo.common.min.css" rel="stylesheet" />
    <link href="../lib/kendoUI/styles/kendo.default.min.css" rel="stylesheet" />
    <link href="../lib/kendoUI/styles/kendo.dataviz.min.css" rel="stylesheet" />
    <link href="../lib/kendoUI/styles/kendo.dataviz.default.min.css" rel="stylesheet" />
    <link href="../lib/kendoUI/styles/kendo.flat.mobile.min.css" rel="stylesheet">
    <link href="../resources/styles/default.css" rel="stylesheet">
    <script src="../lib/kendoUI/js/jquery.min.js"></script>
    <script src="../lib/kendoUI/js/kendo.all.min.js"></script>

</head>
<body>
<div data-role="view" id="welcomeView"  data-stretch="true" data-persist="true" data-transition="overlay:down">

    <div id="welcomeContent">
        <p><img src="../resources/images/logo2.png" width="100" height="125"/></p>
        <div id="header">

            <p>DTI-TDL</p>
        </div>
        <div id="content">
            <a id="settingBtn" class="boxbutton" href="#serial_setting_form" data-role="button" data-transition="overlay:up">
                <img src="../resources/images/setting2.png" width="64" height="64"/>
                SETTINGS
            </a>
            &NonBreakingSpace;

            <a id="connectBtn" class="boxbutton" href="#">
                <img src="../resources/images/connect2.png" width="64" height="64"/>
                CONNECT
            </a>








        </div>
        <div id="footer">

        </div>

    </div>


</div>


<div data-role="view" id="serial_setting_form" data-title="Settings" data-transition="overlay:up" data-persist="true">
    <header data-role="header">
        <div data-role="navbar">
            <a id="setting-back-button" class="nav-button" data-align="left" href="#welcomeView" data-role="button">Back</a>
            <span data-role="view-title"></span>
            <a id="setting-save-button" class="nav-button" data-align="right" data-role="button">Save</a>
        </div>
    </header>
    <form action="./index.html">
        <ul id="setting_list_form" data-role="listview" data-style="inset">
            <li>
                <label>Profile
                    <select id="comm_profile" onChange="changeProfile()">

                    </select>
                </label>
            </li>
            <li>
                <label>Communication Port
                    <select id="comm_port">
                        <option value="COM1">COM1</option>
                        <option value="COM2">COM2</option>
                        <option value="COM3">COM3</option>
                        <option value="COM4">COM4</option>
                        <option value="COM5">COM5</option>
                    </select>
                </label>
            </li>
            <li>
                <label>Bit Rate
                    <select id="bit_rates">
                        <option value="115200">115200</option>
                        <option value="57600">57600</option>
                        <option value="38400">38400</option>
                        <option value="19200">19200</option>
                        <option value="9600">9600</option>
                        <option value="4800">4800</option>
                    </select>
                </label>
            </li>
            <li>
                <label>Data Bits
                    <select id="databits">
                        <option value="8">8</option>
                        <option value="7">7</option>
                        <option value="6">6</option>
                        <option value="5">5</option>
                    </select>
                </label>
            </li>
            <li>
                <label>Stop Bits
                    <select id="stopbits">
                        <option value="2">2</option>
                        <option value="1.5">1.5</option>
                        <option value="1" selected>1</option>
                    </select>
                </label>
            </li>
            <li>
                <label>Parity Bits
                    <select id="parity">
                        <option value="Space">Space</option>
                        <option value="Mark">Mark</option>
                        <option value="Odd">Odd</option>
                        <option value="Even">Even</option>
                        <option value="None" selected>None</option>
                    </select>
                </label>
            </li>
            <li>
                <label>Flow Control
                    <select id="flowcontrol">
                        <option value="Hardware">Hardware</option>
                        <option value="XonXoff">Xon/Xoff</option>
                        <option value="None" selected>None</option>
                    </select>
                </label>
            </li>

        </ul>
        <div data-role="footer" style="background: none; padding: 5px; text-align: center;">
            <a class="delete-button" id="setting-delete-button" type="button" data-role="button">Delete</a>
        </div>
    </form>
</div>


<div data-role="modalview" id="modalview-database-error" style="width: 220px;">
    <div data-role="header">
        <div data-role="navbar">
            <span class="modal-header">Database error</span>
        </div>
    </div>

    <div class="modal-content" data-role="contentview" style="padding: 5px;">

        <p id="db-error"></p>
    </div>

    <div data-role="footer" style="background: none; padding: 5px;">
        <a class="modal-button" data-click="closeModalViewDBErrAndRetry" id="modalview-db-retry-button" type="button" data-role="button">Retry</a>
        <a class="modal-button" data-click="closeModalViewDBErrAndExit" id="modalview-db-exit-button" type="button" data-role="button">Close</a>
    </div>

</div>

<div data-role="modalview" id="modalview-connection-error" style="width: 220px;">
    <div data-role="header">
        <div data-role="navbar">
            <span class="modal-header">Connection error</span>
        </div>
    </div>

    <div class="modal-content" data-role="contentview" style="padding: 5px;">
        Can not connect to TDL Server

    </div>

    <div data-role="footer" style="background: none; padding: 5px;">
        <a class="modal-button" data-click="closeModalViewConnErrAndRetry" id="modalview-conn-retry-button" type="button" data-role="button">Retry</a>
        <a class="modal-button" data-click="closeModalViewConnErrAndExit" id="modalview-conn-exit-button" type="button" data-role="button">Exit</a>
    </div>

</div>
<div data-role="modalview" id="modalview-form-error" style="width: 220px;">
    <div data-role="header">
        <div data-role="navbar">
            <span class="modal-header">Form error</span>
        </div>
    </div>

    <div class="modal-content" data-role="contentview" style="padding: 5px;">
        <p id="form-error"></p>

    </div>

    <div data-role="footer" style="background: none; padding: 5px;">
        <a class="modal-button" data-click="closeModalViewFormErr" id="modalview-form-exit-button" type="button" data-role="button">OK</a>
    </div>

</div>

<div data-role="layout" id="app-main-tabstrip" data-id="mobile-tabstrip">
    <header data-role="header">
        <div data-role="navbar">
            <a id="left-drawer-button" class="nav-button" data-align="left" href="#left-drawer" data-rel="drawer" data-role="button" data-icon="mydrawer"></a>
            <span data-role="view-title"></span>
            <a id="right-drawer-button" class="nav-button" data-align="right" href="#right-drawer" data-rel="drawer" data-role="button" data-icon="myinfo"></a>
        </div>
    </header>

    <div data-role="footer">
        <div data-role="tabstrip">
            <a href="#tabstrip-tacmap" data-icon="contacts">Map
            </a><a href="#tabstrip-tacmsg" data-icon="history">Messages
        </a><a href="#tabstrip-tacnews" data-icon="favorites">News
        </a><a href="#tabstrip-members" data-icon="favorites">Members
        </a>
        </div>
    </div>
</div>

<div data-role="view" id="tabstrip-tacmap" data-title="Tactical Map" data-layout="mobile-tabstrip">

</div>
<div data-role="view" id="tabstrip-tacmsg" data-title="Tactical Messages" data-layout="mobile-tabstrip">

</div>
<div data-role="view" id="tabstrip-tacnews" data-title="Tactical News" data-layout="mobile-tabstrip">

</div>
<div data-role="view" id="tabstrip-members" data-title="Members" data-layout="mobile-tabstrip">

</div>

<div data-role="drawer" id="left-drawer" data-title="Config" data-swipe-to-open="false" data-position="left">
    <header data-role="header">
        <div data-role="navbar">
            <span data-role="view-title"></span>
        </div>
    </header>

    <ul data-role="listview">
        <li data-icon="camera">Nature Photography</li>
        <li data-icon="camera">Wildlife Photography</li>
        <li data-icon="camera">Night Photography</li>
        <li data-icon="camera">Fine Art Photography</li>
        <li data-icon="camera">Portrait Photography</li>
        <li data-icon="printer">3D Printing</li>
        <li data-icon="comments">CSS3 Community</li>
        <li data-icon="comments">HTML5 Community</li>
        <li data-icon="comments">Java User Groups</li>
        <li data-icon="comments">Graphic Design</li>
        <li data-icon="comments">Bodybuilding</li>
        <li data-icon="comments">JavaScript</li>
        <li data-icon="comments">C#</li>
        <li data-icon="graph">DataViz</li>
    </ul>
</div>
<div data-role="drawer" id="right-drawer" data-title="Info" data-swipe-to-open="false" data-position="right">
    <header data-role="header">
        <div data-role="navbar">
            <span id="connected_profile" data-align="left">Default</span>
            <span data-role="view-title"></span>
            <span id="connected_time" data-align="right">00:00:00</span>
        </div>
    </header>
</div>


<div class="k-loading-mask" style="width:100%;height:100%;background-color: rgba(255,255,255,0.8);">
    <span class="k-loading-text">Loading...</span>
    <div class="k-loading-image">
        <div class="k-loading-color"></div>
    </div>
</div>
<script>
var gui = require('nw.gui');
var net = require('net');
var app;
var client = null;
var reconnectAttempts = 0;
var maxReconnectAttempts = 3;
var reqMsg = "";
var isFirstResponse = true;
function requestMsg(msg) {

    client = net.connect(9889, 'localhost');
    // Add a 'data' event handler for the client socket
    // data is what the server sent to this socket
    client.on('data', function(data) {

        //console.log(data);
        var retStr = bin2String(data);
        var obj = JSON.parse(retStr);
        console.log(obj);

        client.destroy();
        reconnectAttempts = 0;

        if(obj.msg_name=='response server status') {
            var serverStatus = obj.serverStatus;
            if(serverStatus.status_name=="isRunning"&&serverStatus.status_result=="OK") {

                reqMsg = formatControlMessage('get profiles', null);
                requestMsg(reqMsg);

            }

        }

        if(obj.msg_name=='list profiles' && (obj.msg_err==""||obj.msg_err==null)) {
            //console.log(obj);
            var conn_profiles = obj.conn_profiles;
            if($('#new_comm_profile').val()!=undefined) {
                $('#new_comm_profile').replaceWith('<select id="comm_profile"></select>');
            }
            $('#comm_profile').empty();
            for(var i=0;i<conn_profiles.length;i++) {
                var conn_profile = conn_profiles[i];
                //console.log(conn_profile);
                $('#comm_profile').append('<option value="'+conn_profile.profileId+'">'+conn_profile.profileName+'</option>');

            }
            $('#comm_profile').append('<option value="0">New profile</option>');
            if(isFirstResponse) {
                initApp();
                isFirstResponse = false;
            }
            getProfile(1);


        } else {
            $('#db-error').text('Cannot list profiles from DB');
            $('#modalview-db-error').kendoMobileModalView('open');
        }

        if(obj.msg_name=='response profile' && (obj.msg_err==""||obj.msg_err==null)) {
            console.log(obj);
            var conn_profiles = obj.conn_profiles;

            var conn_profile = conn_profiles[0];
            //console.log(conn_profile);
            $('#comm_port').val(conn_profile.comm_port);
            $('#bit_rates').val(conn_profile.bit_rates);
            $('#databits').val(conn_profile.data_bits);
            $('#stop_bits').val(conn_profile.stop_bits);
            $('#parity').val(conn_profile.parity);
            $('#flowcontrol').val(conn_profile.flowcontrol);
            revealApp();
        } else {
            $('#db-error').text('Cannot get profile from DB');
            $('#modalview-db-error').kendoMobileModalView('open');
        }

        if(obj.msg_name=='response update profile' && (obj.msg_err==""||obj.msg_err==null)) {
            reqMsg = formatControlMessage('get profiles', null);
            requestMsg(reqMsg);
        } else {
            $('#db-error').text('Cannot update profile : '+obj.msg_err);
            $('#modalview-db-error').kendoMobileModalView('open');
        }

        if(obj.msg_name=='response connect' && (obj.msg_err==""||obj.msg_err==null)) {
            app.navigate("tabstrip-tacmap","slide:right");
            $('#connected_profile').text($('#comm_profile option:selected').text());
        } else {
            $('#db-error').text('Cannot update profile : '+obj.msg_err);
            $('#modalview-db-error').kendoMobileModalView('open');
        }
    });

    // Add a 'close' event handler for the client socket
    client.on('close', function() {
        console.log('Connection closed');
    });

    client.on('error', function(err) {
        console.log(err);
        if(reconnectAttempts<=maxReconnectAttempts) {
            reconnectAttempts++;
            setTimeout(requestMsg,500,msg);
        } else if(err.code=='ECONNREFUSED') {
            $('#modalview-connection-error').kendoMobileModalView('open');
        }

    });

    client.write(msg,'UTF-8');
    client.end();
}

function initApp() {
    //getProfile(1);
    //$('#comm_profile').change(changeProfile());

    $('#setting-save-button').click(function(){
        //console.log('--- '+$('#new_comm_profile').val());
        if($('#new_comm_profile').val()!=undefined) {
            if($('#new_comm_profile').val()=="") {
                $('#form-error').text("Profile name cannot be blank");
                $('#modalview-form-error').kendoMobileModalView('open');
            } else {
                var params = '{"profileName":"'+$('#new_comm_profile').val()+'",'
                        +'"comm_port":"'+$('#comm_port').val()+'",'
                        +'"bit_rates":'+$('#bit_rates').val()+','
                        +'"data_bits":'+$('#databits').val()+','
                        +'"stop_bits":"'+$('#stopbits').val()+'",'
                        +'"parity":"'+$('#parity').val()+'",'
                        +'"flowcontrol":"'+$('#flowcontrol').val()+'"'
                        +'}';
                reqMsg = formatControlMessage('add new profile', params);
                setTimeout(requestMsg,100,reqMsg);
            }

        } else if($('#comm_profile').val()!=undefined&&$('#comm_profile').val()!=0) {
            var params = '{"profileId":'+$('#comm_profile').val()+','
                    +'"comm_port":"'+$('#comm_port').val()+'",'
                    +'"bit_rates":'+$('#bit_rates').val()+','
                    +'"data_bits":'+$('#databits').val()+','
                    +'"stop_bits":"'+$('#stopbits').val()+'",'
                    +'"parity":"'+$('#parity').val()+'",'
                    +'"flowcontrol":"'+$('#flowcontrol').val()+'"'
                    +'}';
            reqMsg = formatControlMessage('update profile', params);
            setTimeout(requestMsg,100,reqMsg);
        }
    });

    $('#connectBtn').click(function(){
        connectSerial();
    });

}

function changeProfile() {

    //console.log($('#comm_profile option:selected').val());
    if($('#comm_profile option:selected').val()!=0) {
        getProfile($('#comm_profile option:selected').val());
    } else {
        $('#comm_profile').replaceWith('<input type="text" name="new_comm_profile" id="new_comm_profile">');
        $('#setting-back-button').replaceWith('<a id="setting-cancel-button" class="nav-button" data-align="left" data-role="button">Cancel</a>');
        $('#setting-cancel-button').kendoMobileButton();
        $('#setting-cancel-button').click(function(){
            $('#setting-cancel-button').replaceWith('<a id="setting-back-button" class="nav-button" data-align="left" href="#welcomeView" data-role="button">Back</a>');
            $('#setting-back-button').kendoMobileButton();
            $('#new_comm_profile').replaceWith('<select id="comm_profile" onChange="changeProfile()"></select>');

            getProfiles();

        });
    }

}
function getProfile(id) {
    reqMsg = formatControlMessage('get profile', '{"profileId":'+id+'}');
    setTimeout(requestMsg,500,reqMsg);
}
function getProfiles() {
    reqMsg = formatControlMessage('get profiles', null);
    requestMsg(reqMsg);
}
function bin2String(array) {

    var result = "";
    var foundJSONstr = false;
    for (var i = 0; i < array.length; i++) {
        if(array[i]==123&&!foundJSONstr) {
            foundJSONstr = true;
        }
        if(foundJSONstr) {
            result += String.fromCharCode(array[i]);
        }

    }
    console.log(result);
    return result;
}
function formatControlMessage(cmsg,params) {


    return JSON.stringify({
        msg_name: cmsg,
        msg_params: params
    });


}


function revealApp() {
    $('div.k-loading-mask').remove();
}

function closeModalViewConnErrAndRetry() {
    $('#modalview-connection-error').kendoMobileModalView('close');
    var reqStatus =formatControlMessage('request server status', null);
    setTimeout(requestMsg,500,reqStatus);
}

function closeModalViewConnErrAndExit() {
    $('#modalview-connection-error').kendoMobileModalView('close');
    gui.App.quit();
}

function closeModalViewDBErrAndRetry() {
    $('#modalview-db-error').kendoMobileModalView('close');
    setTimeout(requestMsg,500,reqMsg);
}

function closeModalViewDBErrAndExit() {
    $('#modalview-connection-error').kendoMobileModalView('close');
    //gui.App.quit();
}

function closeModalViewFormErr() {
    $('#modalview-form-error').kendoMobileModalView('close');
    //gui.App.quit();
}

function connectSerial() {
    var params = '{"comm_port":"'+$('#comm_port').val()
            +'","bit_rates":'+$('#bit_rates').val()
            +',"data_bits":'+$('#databits').val()
            +',"stop_bits":"'+$('#stopbits').val()
            +'","parity":"'+$('#parity').val()
            +'","flowcontrol":"'+$('#flowcontrol').val()
            +'"}';
    reqMsg =formatControlMessage('connect', params);
    setTimeout(requestMsg,1000,reqMsg);
}
$(document).ready(function(){
    reqMsg =formatControlMessage('request server status', null);
    setTimeout(requestMsg,1000,reqMsg);
    //console.log(process.mainModule.exports.dirname);
    app = new kendo.mobile.Application(document.body);
});

</script>
</body>
</html>